rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can read/write their own user document.
    match /users/{userId} {
      allow read, write: if request.auth.uid == userId;
    }

    // Rules for projects
    match /projects/{projectId} {
      // Allow a user to read a project only if they are a member.
      allow read: if request.auth.uid in resource.data.memberIds;

      // Allow a user to create/update a project if they are in the new members list.
      allow create, update: if request.auth.uid in request.resource.data.memberIds;

      // Allow a member to delete a project.
      allow delete: if request.auth.uid in resource.data.memberIds;
    }

    // Rules for invitations
    match /invitations/{invitationId} {
      // Allow a user to query for invitations sent to their email.
      allow list: if request.auth != null;
      
      // Allow a user to read or update an invitation if it is addressed to them.
      allow read, update: if request.auth.email == resource.data.email;

      // Allow any project member to create new invitations.
      allow create: if get(/databases/$(database)/documents/projects/$(request.resource.data.projectId)).data.memberIds.hasAny([request.auth.uid]);
    }
  }
}